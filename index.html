<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Imagining A World Without Caching</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/custom.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<!-- 1. Title -->
				<section>
					<h1>Imagining A World Without Caching</h1>
				</section>

				<!-- 2. Who Am I? -->
				<section>
					<h1>Who Am I?</h1>
					<ul>
					<li class="fragment">Magento Developer at Something Digital (Magento Gold Solution Partner)</li>
					<li class="fragment">Actively blogging about Magento and other technology</li>
					<li class="fragment">Spoken at NomadMage, NYC Magento meetup.</li>
					</ul>
				</section>

				<!-- 3. Set up -->
				<section>
					<section>
						<p>There are only two hard things in Computer Science: cache invalidation and naming things.</p>
						<p>- Phil Karlton</p>
					</section>
					<section>
						<img src="img/performance-is-not-about-caching.png" alt="" width="600" />
						<p><a href="https://community.magento.com/t5/Magento-Imagine-DevExchange-2017/Performance-is-not-about-caching/idi-p/61942">https://community.magento.com/t5/Magento-Imagine-DevExchange-2017/Performance-is-not-about-caching/idi-p/61942</a></p>
					</section>
					<section>
						<img src="img/caching-is-not-performance-optimization.png" alt="" width="600" />
						<p><a href="http://www.kingletas.com/2012/08/caching-performance-optimization.html">http://www.kingletas.com/2012/08/caching-performance-optimization.html</a></p>
					</section>
					<section>
						<img src="img/stack-exchange.png" alt="" width="600" />
						<p><a href="https://magento.stackexchange.com/questions/3806/pre-warming-the-magento-enterprise-full-page-cache">https://magento.stackexchange.com/questions/3806/pre-warming-the-magento-enterprise-full-page-cache</a></p>
					</section>
					<section>
						<p>Why bother with caching?</p>
					</section>
					<section>
						<h3>Types of caching when making an HTTP request to Magento...</h3>
						<x-agenda data-show-and-more="1" data-fragmented="1"></x-agenda>
					</section>
					<section>
						<p>Let's imagine a world without any caching...</p>
					</section>
				</section>

				<!-- 4. Browser Caching -->
				<section>
					<section>
						<h1>Browser Cache</h1>
					</section>
					<section>
						<h3>What Is It?</h3>
						<ul>
							<li class="fragment">When you make a request your browser will first check it's cache to see if the response is available.</li>
							<li class="fragment">Cache contents are stored on your local device.</li>
							<li class="fragment">If the response is in cache, the request never hits the network.</li>
							<li class="fragment">Your application uses HTTP response headers to instruct the browser how to cache the response.</li>
						</ul>
					</section>
					<section data-markdown>
						<script type="text/template">
						<h3>Apache Configuration</h3>
						```
						<IfModule mod_expires.c>

						############################################
						## Add default Expires header
						## http://developer.yahoo.com/performance/rules.html#expires

						    ExpiresDefault "access plus 1 year"
						    ExpiresByType text/html A0
						    ExpiresByType text/plain A0

						</IfModule>
						```
						</script>
					</section>
					<section>
						<h3>Imagining A World Without It</h3>
						<a href="http://www.webpagetest.org/result/170418_CF_068e646b72e79540d5eba4037a346446/">
							<img src="img/browser-caching-web-page-test.png" alt="" width="800" />
						</a>
						<p style="font-size: 24px;"><a href="http://www.webpagetest.org/result/170418_CF_068e646b72e79540d5eba4037a346446/">http://www.webpagetest.org/result/170418_CF_068e646b72e79540d5eba4037a346446/</a></p>
					</section>
					<section>
						<p>Improvements will be even <strong>more</strong> drastic on real world sites</p>
					</section>
					<section>
						<h3>Pro Tips</h3>
						<ul>
							<li class="fragment">Magento 2 has built in cache busting via static asset deployment, but it could be smarter / more flexible.</li>
							<li class="fragment">Magento 1 does not support cache busting out-of-the-box.</li>
							<li class="fragment">Magento's built in merge JavaScript / merge CSS feature is bad for browser cache. Use HTTP/2 or roll your own.</li>
							<li class="fragment">Be very careful with caching HTML documents. There's no way to invalidate them.</li>
						</ul>
					</section>
					<section>
						<h3>Recommended Reading</h3>
						<ul>
							<p><a href="https://rmurphey.com/blog/2015/11/25/building-for-http2">Building for HTTP/2 - Rebecca Murphey</a></p>
						</ul>
					</section>
				</section>

				<!-- 4. DNS Caching -->
				<section>
					<section>
						<h3>Agenda</h3>
						<x-agenda data-current-index="1"></x-agenda>
					</section>
					<section>
						<h1>DNS Caching</h1>
					</section>
					<section>
						<h3>What Is It?</h3>
						<ul>
							<li class="fragment">When a request hits the network, DNS is used to understand which server to go to.</li>
							<li class="fragment">DNS records are hosted on nameservers.</li>
							<li class="fragment">A TTL is included in each DNS record. Your computer and the internet cache DNS records for that long.</li>
							<li class="fragment">If the DNS record is in cache, the nameserver does not need to be consulted to find where to go.</li>
						</ul>
					</section>
					<section>
						<h3>TTL</h3>
						<ul>
							<img src="img/dns-ttl.jpg" alt="" />
						</ul>
					</section>
					<section>
						<h3>TTL Strategies</h3>
						<ul>
							<li class="fragment">Set it low (e.g 5 minutes) for instant changes - <a href="https://blog.cloudflare.com/never-deal-with-dns-propagation-again/">Cloudflare, Never deal with propagation again</a></li>
							<li class="fragment">Compromise between fast changes and cache hit rate (e.g. 1 hour) - <a href="http://dyn.com/blog/dyn-tech-everything-you-ever-wanted-to-know-about-ttls/">Dyn, Everything You Ever Wanted To Know About TTLs</a></li>
							<li class="fragment">Set it high (e.g. 24 hours). Decrease it before you make changes. Then set it high again - <a href="https://support.rackspace.com/how-to/about-ttl-best-practices/">Rackspace, Best Practices for using TTL</a></li>
						</ul>
					</section>
					<section>
						<h3>Imagining A World Without It</h3>
						<img src="img/StockSnap_GFIZG3CMEB-asking-directions.jpg" width="500">
						<p><strong>Every</strong> request your browser makes takes additional round trip to name server get address</p>
					</section>
				</section>

				<!-- 5. Edge Caching -->
				<section>
					<section>
						<h3>Agenda</h3>
						<x-agenda data-current-index="2"></x-agenda>
					</section>
					<section>
						<h1>Edge Cache / CDNs</h1>
					</section>
					<section>
						<h3>What Is It?</h3>
						<ul>
							<li class="fragment">Traditionally, when a request hits the network, it travels from the location of the user to the server hosting the response.</li>
							<li class="fragment">CDNs ("Content Delivery Networks") sit between the user and the server ("at the edge") and cache responses.</li>
							<li class="fragment">CDNs ("Content Delivery Networks") have many edges all around the world.</li>
							<li class="fragment">Frequently used with static assets (img, js, css), but HTML can be served from the edge too.</li>
						</ul>
					</section>
					<section>
						<h3>Why?</h3>
						<ul>
							<li class="fragment">Responses cached at edge are closer geographically to user, reducing round-trip-time.</li>
							<li class="fragment">Frees up resources on your origin webserver to focus on executing PHP, MySQL, etc...</li>
						</ul>
					</section>
					<section>
						<h3>Imagining A World Without It</h3>
						<img src="img/exhausted.jpeg" width="500">
						<p>Requests for assets must travel all the way to origin server, regardless of geographic user of end server.</p>
					</section>
					<section>
						<h3>Some Popular Providers...</h3>
						<ul>
							<li class="fragment">Cloudflare</li>
							<li class="fragment">Cloudfront (Amazon)</li>
							<li class="fragment">Akamai</li>
							<li class="fragment">Fastly (Magento cloud)</li>
							<li class="fragment">Section.io</li>
						</ul>
					</section>
				</section>

				<!-- 6. (Full) Page Caching -->
				<section>
					<section>
						<h3>Agenda</h3>
						<x-agenda data-current-index="3"></x-agenda>
					</section>
					<section>
						<h1>(Full) Page Cache</h1>
					</section>
					<section>
						<h3>What Is It?</h3>
						<ul>
							<li class="fragment">When Magento handles a request there is a lot of work required to generate the resulting HTML.</li>
							<li class="fragment">Full Page Caching reuses the generated static HTML in subsequent requests.</li>
							<li class="fragment">In Magento 2 you can use Varnish as a reverse proxy. It is included in CE.</li>
							<li class="fragment">In Magento 1 page cache is EE only. Request is still handled by the web server and saved to cache backend. Community plugins support both caching strategies.</li>
						</ul>
					</section>
					<section>
						<p>"Full Page Caching reuses the generated static HTML in subsequent requests." - Me, just now</p>
						<p class="fragment">But we can't serve it <strong>all</strong> statically</p>
					</section>
					<section>
						<h3>Strategies For Dealing With Personalized Content</h3>
						<ul>
						<li class="fragment">ESI</li>
						<li class="fragment">AJAX (Magento 2)</li>
						<li class="fragment">"Containers" (Magento 1)</li>
						</ul>
					</section>
					<section>
						<h3>Imagining A World Without It</h3>
						<img src="img/m2-page-cache-ttfb.png">
						<a href="https://inviqa.com/blog/how-full-page-cache-works-magento-2">https://inviqa.com/blog/how-full-page-cache-works-magento-2</a>
					</section>
					<section>
						<h3>Imagining A World Without It</h3>
						<p>"It typically speeds up delivery with a factor of 300 - 1000x, depending on your architecture." - <a href="https://varnish-cache.org/intro/">https://varnish-cache.org/intro/</a></p>
					</section>
					<section>
						<h3>Pro Tips</h3>
						<ul>
							<li class="fragment">Strip query params the server doesn't need to increase hit rate (e.g. gclid).</li>
							<li class="fragment">Easy to mess up. Monitor your hit rate!</li>
						</ul>
					</section>
					<section>
						<h3>Tracking Query Params Registry</h3>
						<ul>
							<img src="img/tracking-query-params-registry.png" width="800">
							<p style="font-size: 24px;"><a href="https://github.com/mpchadwick/tracking-query-params-registry/blob/master/data.csv">https://github.com/mpchadwick/tracking-query-params-registry</a></p>
						</ul>
					</section>
				</section>

				<!-- 7. Code Caching -->
				<section>
					<section>
						<h3>Agenda</h3>
						<x-agenda data-current-index="4"></x-agenda>
					</section>
					<section>
						<h1>Code caching</h1>
					</section>
					<section>
						<h3>What Is It?</h3>
						<ul>
							<li class="fragment">Some application code is expensive to run.</li>
							<li class="fragment">The result of the code is saved somewhere.</li>
							<li class="fragment">Next time the code needs to run it first checks if the response is in cache</li>
							<li class="fragment">The cache result can persist requests (e.g. saved in redis) or be reused in context of single request (saved in variable)</li>
						</ul>
					</section>
					<section>
						<h3>Examples In Magento (persisting requests)</h3>
						<ul>
							<li class="fragment">Config cache</li>
							<li class="fragment">Layout cache</li>
							<li class="fragment">Block cache</li>
							<li class="fragment">Opcache</li>
						</ul>
					</section>
					<section data-markdown>
						<script type="text/template">
						<h3>Reusing within a single request</h3>
						```php
						// This method will be called for each product
						// on the listing page
						public function getExpensiveValue()
						{
						    if ($this->expensiveValueToGenerate !== null) {
						        return $this->expensiveValueToGenerate;
						    }

						    return $this->generateAndCacheExpensiveValueToGenerate();
						}
						```
						</script>
					</section>
					<section>
						<h3>Imagining A World Without It</h3>
						<img src="img/m2-cache-ttfb.png">
					</section>
				</section>

				<!-- 8. MySQL Query Caching -->
				<section>
					<section>
						<h3>Agenda</h3>
						<x-agenda data-current-index="5"></x-agenda>
					</section>
					<section>
						<h1>MySQL Query Cache</h1>
					</section>
					<section data-markdown>
						<script type="text/template">
						<h3>What Is It?</h3>
						<ul>
							<li class="fragment">Some database `SELECT` queries are expensive to run.</li>
							<li class="fragment">The result of the query is saved to the query cache.</li>
							<li class="fragment">When the same query is run the next time it is pulled from cache.</li>
							<li class="fragment">When tables are modified any relevant query cache entries are flushed.</li>
						</ul>
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
						<h3>Caveats</h3>
						<ul>
							<li class="fragment">Queries must be <strong>exactly</strong> the same (byte for byte).</li>
							<li class="fragment">Queries using function such as `NOW()` or `CURDATE()` are not cached.</li>
						</ul>
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
						<h3>How It's Used</h3>
						<pre style="text-align: center"><code class="lang-mysql">query_cache_type = 1
						query_cache_size = 100M
						query_cache_limit = 2M
						</code></pre>
						</script>
					</section>
					<section>
						<h3>Imagining A World Without It</h3>
						<img src="img/gears-cogs-machine-machinery-159298.jpg" width="500">
						<p>MySQL re-runs <strong>every</strong> query</p>
					</section>
					<section>
						<h3>Controversy!</h3>
						<p>Although MySQL Query Cache was meant to improve performance, it has serious scalability issues and it can easily become a severe bottleneck.</p>
						<p><a href="http://mysqlserverteam.com/mysql-8-0-retiring-support-for-the-query-cache/">MySQL 8.0: Retiring Support for the Query Cache - MySQL Server Blog</a></p>
					</section>
					<section>
						<h3>Counterpoint</h3>
						<p>With Magento, you can expect to have a light write workload, very low concurrency and also quite complex SELECT statements. Given the results of our simple benchmarks, it is finally not that surprising that the MySQL query cache is a good fit in this case.</p>
						<p><a href="https://www.percona.com/blog/2015/08/07/mysql-query-cache-worst-enemy-best-friend/">The MySQL query cache: Worst enemy or best friend? - Percona</a></p>
					</section>
					<section>
						<h3>Pro Tips</h3>
						<ul>
							<li class="fragment"><a href="https://maxchadwick.xyz/blog/mysql-query-cache-hit-rate">Check your hit rate</a></li>
							<li class="fragment">For high throughput sites it may actually hurt you, due to locking. Be ready to tune and refine.</li>
							<li class="fragment"><a href="http://proxysql.com/">ProxySQL</a> is an interesting query cache replacement, and official endorsed by MySQL dev team.</li>
						</ul>
					</section>
				</section>

				<!-- 9. Linux Page Caching -->
				<section>
					<section>
						<h3>Agenda</h3>
						<x-agenda data-current-index="6"></x-agenda>
					</section>
					<section>
						<h1>Linux Page Cache</h1>
					</section>
					<section>
						<h3>What Is It?</h3>
						<ul>
						<li class="fragment">Reading off disk is slow.</li>
						<li class="fragment">Reading from memory is fast.</li>
						<li class="fragment">Linux caches things it previously read from disk in any available memory.</li>
						</ul>
					</section>
					<section>
						<h3>Imagining A World Without It</h3>
						<img src="img/ripgrep-cache.png" width="500">
					</section>
					<section data-markdown>
						<script type="text/template">
						<h3>Correctly Interpreting `free -m`</h3>
						<img src="img/free-m-results.jpg" width="600">
						</script>
					</section>
				</section>

				<!-- 10. Magento Indexes -->
				<section>
					<section>
						<h3>Agenda</h3>
						<x-agenda data-current-index="7"></x-agenda>
					</section>
					<section>
						<h1>Magento Indexes</h1>
					</section>
					<section>
						<h3>What Is It?</h3>
						<ul>
						<li class="fragment">Calculating things like whether or not a product can be sold, or the final price of a product is an expensive operation.</li>
						<li class="fragment">It would be a lot more efficient to pre-calculate (and cache) these calculations for quicker lookup.</li>
						<li class="fragment">Magento indexes are an faux-implementation of a materialized view to implement this functionality.</li>
						</ul>
					</section>
					<section>
						<p style="font-size: 32px">They are not indexes like a BTree or hash but act more like a pre-calculation table. In SQL parlance this often known as a Materialized View.  This is similar to a regular view, where the table contains the results of a query but unlike a regular view which updates its contents when the row changes a Materialized View does not.</p>
						<p style="font-size: 32px">MySQL does not support Materialized Views and so Magento implemented a sort of pseudo-Materialized View.</p>
						<p style="font-size: 32px"><a href="http://www.eschrade.com/page/indexing-in-magento-or-the-wonderful-world-of-materialized-views/">(New(ish)) Indexing in Magento or "The wonderful world of materialized views" - Kevin Schroeder</a></p>
					</section>
					<section>
						<h3>Imagining A World Without It</h3>
						<img src="img/traffic-from-above_4460x4460.jpg" width="500">
						<p>Magento page load times tank as it chugs away calculating product prices, attribute values, and product sale-ability.</p>
					</section>
					<section>
						<h3>Pro Tips</h3>
						<ul>
							<li class="fragment">Set indexing mode to run on schedule (EE only in M1, included in CE in M2)</li>
							<li class="fragment"><a href="https://maxchadwick.xyz/blog/magento-enterprise-index-lesson-329">Be careful with the changelog tables when transfering data to stage / dev or you might break indexing</a></li>
						</ul>
					</section>
				</section>

				<!-- 11. Conclusion -->
				<section>
					<section>
						<h1>Conclusion</h1>
					</section>
					<section>
						<img src="img/caching-is-not-performance-google-search.png" width="600">
					</section>
					<section>
						<h3>"Caching != Performance"</h3>
						<ul>
						<li class="fragment">This statement is patently false.</li>
						<li class="fragment">The goal of "performance" is to make things faster.</li>
						<li class="fragment">Caching is a tried and true strategy for doing that at all levels of the stack.</li>
						</ul>
					</section>
					<section>
						<h3>The correct message</h3>
						<ul>
						<li class="fragment">Caching is not the only part of performance.</li>
						</ul>
					</section>
					<section>
						<h3>Other important things for a performant Magento site (a few)</h3>
						<ul>
						<li class="fragment">Efficient data querying.</li>
						<li class="fragment">Avoiding model LSD in loop.</li>
						<li class="fragment">Minimizing bytes sent across the network (images, scripts, styles).</li>
						<li class="fragment">Well configured infrastructure.</li>
						</ul>
					</section>
				</section>

				<section>
					<section>
						<h1>Questions?</h1>
					</section>
					<section>
						<h1>THANK YOU!</h1>
					</section>
				</section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				history: true,

				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});

			class XAgenda extends HTMLElement {
				constructor() {
					super();

					var items = [
						'Browser Cache',
						'DNS Cache',
						'Edge Cache / CDN',
						'(Full) Page Cache',
						'Code Cache',
						'MySQL Query Cache',
						'Linux Page Cache',
						'Magento Indexes',
					];

					if (this.getAttribute('data-show-and-more')) {
						items.push('And more!');
					}

					var list = document.createElement('ul');

					items.map((text, index) => {
						let li = document.createElement('li');
						li.innerHTML = (this.getAttribute('data-current-index') == index) ? `<strong>${text}</strong>` : text;
						if (this.getAttribute('data-fragmented')) {
							li.classList.add('fragment');
							li.dataset.fragmentIndex = index;
						}
						list.appendChild(li);
					})

					this.appendChild(list);
				}
			}

			customElements.define('x-agenda', XAgenda);
		</script>
	</body>
</html>
